# MAIN_APP.py 構造調査レポート

**調査日**: 2025-10-25
**対象ファイル**: MAIN_APP.py
**調査時点の行数**: 4,804行
**セッション**: セッション6

---

## 1. 概要統計

| 項目 | 数値 |
|------|------|
| 総行数 | 4,804行 |
| クラス数 | 12個 |
| メソッド数 | 162個 |
| DataFrame操作箇所 | 111箇所 |
| QMessageBox使用箇所 | 84箇所 |
| pandas使用箇所 | 17箇所 |
| メソッド接頭辞別 (on_, clicked_等) | 67個 |

---

## 2. クラス構成詳細

### 2.1 MainData（データクラス）
- **場所**: 54-58行（5行）
- **役割**: グローバルデータの保持
- **プロパティ**:
  - insert_char_1: str
  - insert_char_2: str
  - insert_char_3: str
- **分離可能性**: ★☆☆（既にシンプル、現状維持）
- **依存関係**: なし

---

### 2.2 MyMainWindow（メインクラス）★最重要
- **場所**: 61-3786行（約3,725行）
- **役割**: アプリケーションのメインロジック
- **継承**: QMainWindow, Ui_MainWindow
- **メソッド数**: 約130個

#### 主要な責任範囲
1. **UI初期化とイベント処理**
   - タイプヒント定義（65-160行）
   - setupUi、イベント接続
   - ボタンクリック、ラジオボタン変更

2. **画像表示・操作**
   - 回転、拡大縮小
   - フィット処理（幅/高さ）
   - GraphicsView管理

3. **データ入力・検証・保存**
   - LineEdit管理
   - DataFrame操作（current_df, previous_df, log_df）
   - バリデーション実行

4. **CSV読み書き**
   - pd.read_csv実行
   - to_csv実行
   - ヘッダー有無の制御

5. **PDF処理**
   - PDFページ表示
   - ページ切り替え

6. **モード管理**
   - 8種類のモード（utane, card, foreigner等）
   - モード切り替え時の処理

7. **設定管理**
   - config.json読み書き
   - ウィンドウサイズ、位置の保存

#### 分離可能性: ★★★（最優先リファクタリング対象）

**理由**:
- 単一クラスが多すぎる責任を負っている
- 3,725行は保守困難なサイズ
- 責任ごとに分離可能

---

### 2.3 CustomEventFilterForGraphicsView
- **場所**: 3787-3808行（22行）
- **役割**: GraphicsViewのマウスホイールイベント処理
- **分離可能性**: ★☆☆（既に独立、現状維持）

---

### 2.4 CustomEventFilterForLineEditScale
- **場所**: 3809-3821行（13行）
- **役割**: スケール入力用LineEditのイベント処理
- **分離可能性**: ★☆☆（既に独立、現状維持）

---

### 2.5 CustomEventFilterForLineEdit
- **場所**: 3822-4172行（351行）
- **役割**: データ入力用LineEditのイベント処理
- **メソッド数**: 約20個
- **主要機能**:
  - キー入力フィルタリング
  - フォーカス管理
  - IME制御
  - Enterキー処理
- **分離可能性**: ★★☆（イベント処理層として分離候補）

---

### 2.6 CustomEventFilterForPlaneTextEdit
- **場所**: 4173-4288行（116行）
- **役割**: PlainTextEditのイベント処理
- **分離可能性**: ★☆☆（既に独立）

---

### 2.7 CustomEventFilterForDD
- **場所**: 4289-4315行（27行）
- **役割**: ドロップダウンリストのイベント処理
- **分離可能性**: ★☆☆（既に独立）

---

### 2.8 CustomEventFilterForButtonScrollArea
- **場所**: 4316-4331行（16行）
- **役割**: スクロールエリアボタンのイベント処理
- **分離可能性**: ★☆☆（既に独立）

---

### 2.9 InitDialog（初期設定ダイアログ）
- **場所**: 4332-4802行（471行）
- **役割**: 初期設定ダイアログ
- **継承**: QDialog, Ui_InitDialog
- **メソッド数**: 約15個

#### 主要機能
1. フォルダ選択（画像フォルダ、出力フォルダ）
2. モード選択（8種類から選択）
3. データ検証（過去データの存在確認等）
4. 設定保存（config.jsonへの書き込み）

#### 分離可能性: ★★☆（設定管理層として分離可能）

**理由**:
- 設定関連ロジックをまとめて_config_manager.pyに統合できる
- UIとロジックを分離することで再利用性向上

---

### 2.10 CollationDialog（照合ダイアログ）
- **場所**: 4803-4984行（182行）
- **役割**: データ照合ダイアログ
- **分離可能性**: ★☆☆（既に独立）

---

### 2.11 IMEThread
- **場所**: 4985-5002行（18行）
- **役割**: IME制御用スレッド
- **分離可能性**: ★☆☆（既に独立）

---

### 2.12 SingleApplication
- **場所**: 5003-5050行（48行）
- **役割**: 単一インスタンス制御（QSharedMemoryを使用）
- **分離可能性**: ★☆☆（既に独立）

---

## 3. MyMainWindow メソッド分類

### 3.1 初期化系（約15個）
- `__init__()` - メイン初期化
- `initializer_sub()` - サブ初期化
- `init_graphics_view()` - GraphicsView初期化
- `init_list_widget()` - ListWidget初期化
- 等

### 3.2 イベントハンドラ系（約40個）
- `on_*` - 自動接続イベントハンドラ
- `clicked_*` - ボタンクリック処理
- 例:
  - `on_pushButton_cw_clicked()` - 時計回り回転
  - `clicked_automove_on()` - 自動移動ON
  - `clicked_layout_horizontal()` - レイアウト切り替え

### 3.3 データ操作系（約30個）
- `set_*` - データ設定
- `get_*` - データ取得
- `update_*` - データ更新
- 例:
  - `set_data_to_line_edits()` - LineEditにデータ設定
  - `get_data_from_line_edits()` - LineEditからデータ取得
  - `update_current_df()` - DataFrameを更新

### 3.4 検証系（約10個）
- `check_*` - チェック処理
- 例:
  - `check_type_line_edit()` - 型チェック
  - `check_type_all_line_edit()` - 全LineEditチェック
  - `check_encoding_line_edits()` - エンコードチェック

### 3.5 画像処理系（約15個）
- 回転: `rotate_image()`
- 拡大縮小: `zoom_in()`, `zoom_out()`, `set_scale()`
- フィット: `fit_to_width()`, `fit_to_height()`
- 表示: `set_image_from_pixmap()`

### 3.6 CSV/ファイル操作系（約10個）
- CSV読み書き（DataIO統合済み）
- ファイルパス管理

### 3.7 UI制御系（約20個）
- ウィジェット表示/非表示
- レイアウト変更
- スタイル設定

### 3.8 その他（約22個）
- ログ処理
- エラーハンドリング
- ヘルパーメソッド

---

## 4. 依存関係分析

### 4.1 外部ライブラリ依存
- **PyQt5**: UI全般
- **pandas**: DataFrame操作（17箇所）
- **pathlib**: ファイルパス操作
- **json**: 設定ファイル読み書き

### 4.2 内部モジュール依存
- **_lib._mode_config**: モード設定管理 ✅統合済み
- **_lib._validators**: バリデーション ✅統合済み
- **_lib._image_utils**: 画像ユーティリティ ✅統合済み
- **_lib._data_io**: CSV読み書き ✅統合済み
- **_lib._sub_lib**: サブライブラリ（未整理）
- **_lib._pdf_util**: PDF操作（未整理）
- **_lib._create_data_list**: データリスト作成（未整理）
- 等

### 4.3 強結合箇所
1. **self.xxx** の大量使用
   - UI要素への直接アクセス
   - 状態変数の共有

2. **DataFrame の共有**
   - current_df, previous_df, log_df が111箇所で使用
   - 複数メソッドで変更

3. **config_dict の共有**
   - 多数のメソッドが参照・変更

---

## 5. コード品質の問題点

### 5.1 単一責任原則違反
**問題**: MyMainWindowが多すぎる責任を持つ
**影響**:
- 変更時の影響範囲が大きい
- テストが困難
- 理解に時間がかかる

### 5.2 コードの重複
**問題**: 似たような処理が複数箇所に点在
**例**:
- CSV読み書きパターン（統合済み）
- バリデーション処理（統合済み）
- イベントハンドラの類似コード

### 5.3 マジックナンバー
**問題**: ハードコードされた数値
**例**:
- 10000, 20000, 30000（列インデックス）
- 0.1（delta_scale）

### 5.4 長いメソッド
**問題**: 一部メソッドが100行超
**影響**: 理解困難、テスト困難

### 5.5 テストの欠如
**問題**: 単体テストなし
**リスク**: リファクタリング時のデグレーション

---

## 6. リファクタリング優先順位

### Phase A: MyMainWindow の責任分離（優先度: 高）

#### A-1: UI操作層の分離 ★★★
- **対象**: on_*, clicked_* 系メソッド（約40個）
- **削減見込み**: 200-300行
- **難易度**: 中
- **新モジュール**: `_ui_handlers.py`
- **理由**: イベントハンドラは独立性が高く分離しやすい

#### A-2: 画像処理層の完全分離 ★★☆
- **対象**: 回転、拡大縮小、フィット処理（約15個）
- **削減見込み**: 150-200行
- **難易度**: 中
- **拡張モジュール**: `_image_utils.py`（既存を拡張）
- **理由**: 既存モジュールに追加可能

#### A-3: データ管理層の分離 ★☆☆
- **対象**: DataFrame操作（約20個）
- **削減見込み**: 300-400行
- **難易度**: 高
- **新モジュール**: `_data_manager.py`
- **理由**: 依存関係が複雑、慎重な設計が必要

#### A-4: 設定管理層の完全分離 ★★★
- **対象**: config.json読み書き（約10個）
- **削減見込み**: 100-150行
- **難易度**: 中
- **新モジュール**: `_config_manager.py`
- **理由**: 依存関係が少なく、効果大

### Phase B: InitDialogの分離（優先度: 中）

#### B-1: 初期設定ロジックの分離 ★★☆
- **対象**: InitDialogクラス全体（471行）
- **削減見込み**: 400行
- **難易度**: 中
- **統合先**: `_config_manager.py`
- **理由**: 設定管理と統合で効率化

### Phase C: イベントフィルタの統合（優先度: 低）

#### C-1: イベントフィルタクラスの整理 ★☆☆
- **対象**: CustomEventFilter系クラス（約550行）
- **削減見込み**: 50-100行
- **難易度**: 低
- **新モジュール**: `_event_filters.py`
- **理由**: 効果は限定的

---

## 7. 推奨ロードマップ

### セッション7（次回）
1. **Phase A-4**: 設定管理層の分離
   - config.json操作を_config_manager.pyに統合
   - 削減見込み: 100-150行
   - 所要時間: 1-2時間

2. **Phase A-1**: UI操作層の分離
   - イベントハンドラを_ui_handlers.pyに分離
   - 削減見込み: 200-300行
   - 所要時間: 2-3時間

**セッション7目標**: 300-450行削減（4,800行→4,350-4,500行）

### セッション8
1. **Phase A-2**: 画像処理層の完全分離
   - 削減見込み: 150-200行
2. **Phase B-1**: InitDialogの分離
   - 削減見込み: 400行

**セッション8目標**: 550-600行削減（4,350行→3,750-3,800行）

### セッション9以降
1. **Phase A-3**: データ管理層の分離（慎重に実施）
2. **Phase C-1**: イベントフィルタの統合（時間があれば）

---

## 8. 期待される最終成果

### コード量の変化
| フェーズ | 削減行数 | 累計行数 | 削減率 |
|---------|---------|---------|--------|
| 現在 | - | 4,804行 | - |
| Phase A完了後 | 750-950行 | 約4,000行 | 16% |
| Phase B完了後 | 400行 | 約3,600行 | 25% |
| Phase C完了後 | 50-100行 | 約3,500行 | 27% |

### 最終モジュール構成
```
MAIN_APP.py (3,500行) - メインロジックのみ
├── _lib/
│   ├── _mode_config.py (493行) ✅ 統合済み
│   ├── _validators.py (656行) ✅ 統合済み
│   ├── _image_utils.py (300行) ✅ 統合済み・拡張予定
│   ├── _data_io.py (125行) ✅ 統合済み
│   ├── _config_manager.py (200行) - 新規作成予定
│   ├── _ui_handlers.py (300行) - 新規作成予定
│   ├── _data_manager.py (400行) - 新規作成予定
│   ├── _event_filters.py (200行) - 新規作成予定
│   └── [既存9モジュール]
```

### 保守性の向上
1. **単一責任原則**: 各モジュールが明確な責任を持つ
2. **テスト容易性**: モジュール単位でテスト可能
3. **拡張性**: 新機能追加時の影響範囲が限定的
4. **可読性**: コードの意図が明確、理解しやすい

---

## 9. 技術的な課題と対策

### 9.1 循環インポートのリスク
**問題**: 分離したモジュール間で相互参照が発生する可能性

**対策**:
- 依存関係グラフを事前に作成
- 依存方向を一方向に保つ（下位→上位のみ）
- 必要に応じてファサードパターンを導入

### 9.2 UI依存の処理
**問題**: self.xxx形式でUI要素に直接アクセス

**対策**:
- UI要素を引数で渡す
- UIマネージャークラスを経由してアクセス
- 必要なUI要素のみを渡す（最小権限の原則）

### 9.3 DataFrame操作の複雑さ
**問題**: current_df, previous_df, log_dfが複数箇所で変更される

**対策**:
- DataFrameManagerクラスで状態管理
- 変更操作をメソッド化（カプセル化）
- イミュータブルなアプローチの検討

### 9.4 テストの欠如
**問題**: 既存コードにテストがない

**対策**:
- リファクタリング前に動作確認手順を文書化
- 各ステップで必ずユーザーに動作確認を依頼
- 可能な箇所から単体テストを追加

---

## 10. まとめ

### 現状の評価
- **良い点**:
  - 既に4モジュールの統合完了
  - 279行（5.4%）の削減達成
  - 明確な分離境界が見えている

- **課題**:
  - MyMainWindowが3,725行と巨大
  - 責任範囲が広すぎる
  - テストがない

### 次のアクション
1. **Phase A-4**: 設定管理層の分離（最優先）
2. **Phase A-1**: UI操作層の分離
3. 段階的なリファクタリング継続

### 長期的な展望
- 3,500行まで削減（27%削減）
- モジュール化による保守性向上
- テストカバレッジの向上
- 新機能追加の容易化

---

**調査実施者**: Claude (Sonnet 4.5)
**調査完了日時**: 2025-10-25
